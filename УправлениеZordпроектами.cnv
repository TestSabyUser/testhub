<?xml version="1.0" encoding="WINDOWS-1251" ?>
<converter_library version="1.03">

  <converter abstract="0" call_once="1" deployment_stage="2" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Êàðà÷åâöåâ Þ.Þ." name="ÄîáàâèòüÈñïîëíèòåëÿÊÇàäà÷àìPy_2" python_extension="1" responsible="Êàðà÷åâöåâ Þ.Þ.">
    <callback event="26">
      <body>doctype = SqlQueryScalar(''' select "@ÒèïÄîêóìåíòà" from "ÒèïÄîêóìåíòà" where "ÒèïÄîêóìåíòà"='ÑëóæÇàï' AND "ÏîäÒèïÄîêóìåíòà" is NULL LIMIT 1 ''')
if doctype is None:
   return
   22.7100/1711d1
	      22.7100/1711d1
	      22.7100/1711d1
	      22.7100/1711d1
	      22.7100/1711d1
	      22.7100/1711d1
	      22.7100/1711d122.7100/1711d1
sql='''
INSERT INTO "ËèöîÄîêóìåíòà"("Ëèöî", "Äîêóìåíò", "Òèï", "ÄàòàÂðåìÿ") 
select "Ñîòðóäíèê", "@Äîêóìåíò", 1 AS "Òèï", CURRENT_TIMESTAMP from "Äîêóìåíò" d where 
   d."ÒèïÄîêóìåíòà"={0}
   AND NOT EXISTS(select ld."Äîêóìåíò" from "ËèöîÄîêóìåíòà" ld where ld."Äîêóìåíò"=d."@Äîêóìåíò" AND ld."Òèï" = 1);
'''.format(doctype)
SqlQuery(sql)</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Âîëêîâ Ä.Í." name="ÄîáàâëåíèåÑïèñêàÐàññûëêèÊÑîâåù" responsible="Âîëêîâ Ä.Í.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
   pk_type      integer;
   pk_ext       integer; 
BEGIN

   -- èùåì òèï äîêóìåíòà "Ñîâåùàíèÿ"
   SELECT "@ÒèïÄîêóìåíòà" FROM "ÒèïÄîêóìåíòà" WHERE "ÒèïÄîêóìåíòà" = 'Ñîâåùàíèå' INTO pk_type;
   IF pk_type IS NOT NULL THEN
      -- äîáàâèì åñëè íóæíî òèï îãðàíè÷åíèÿ - "Ñïèñîê ðàññûëêè"
      SElECT "@Îãðàíè÷åíèåÒèïàÄîêóìåíòà" FROM "Îãðàíè÷åíèåÒèïàÄîêóìåíòà" WHERE "ÒèïÄîêóìåíòà" = pk_type AND "Ñâÿçü"=7 INTO pk_ext;
      IF pk_ext IS NULL THEN
         INSERT INTO "Îãðàíè÷åíèåÒèïàÄîêóìåíòà" ( "Ñâÿçü", "ÒèïÄîêóìåíòà", "Íàçâàíèå" )
      	  VALUES ( 7, pk_type, 'Ñïèñîê ðàññûëêè' );
      END IF;
   END IF;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="1" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Çåðíîâ È.À." name="ÇàìåíèòüÎïèñàíèåÍàÄîêóìåíòû" python_extension="1" responsible="Çåðíîâ È.À.">
    <callback event="26">
      <body>recs = SqlQuery(''' SELECT "ÍàñòðîéêàÊàðòî÷êèÄîêóìåíòà" FROM "ÒèïÄîêóìåíòà" WHERE "ÒèïÄîêóìåíòà" = 'Ïðîåêò' LIMIT 1 ''')
if recs:
    json_ = None
    if recs and len(recs) &gt; 0:
        json_ = recs[0].Get("ÍàñòðîéêàÊàðòî÷êèÄîêóìåíòà", None)
    if json_:     
        json_ = json_.replace("Çàêëàäêà Îïèñàíèå", "Çàêëàäêà Äîêóìåíòû")
        SqlQuery(''' UPDATE "ÒèïÄîêóìåíòà" SET "ÍàñòðîéêàÊàðòî÷êèÄîêóìåíòà" = '{}' WHERE "ÒèïÄîêóìåíòà" = 'Ïðîåêò' '''.format(json_))</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="1" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Çåðíîâ È.À." name="ÇàïîëíèòüÏîëåÄëÿÏîèñêà" python_extension="1" responsible="Çåðíîâ È.À.">
    <callback event="26">
      <body>sql = """SELECT "@ÒèïÄîêóìåíòà" FROM "ÒèïÄîêóìåíòà" WHERE "ÒèïÄîêóìåíòà" = 'ÏëàíÐàáîò' """
type_doc = SqlQueryScalar(sql)
if type_doc:
   upd = """UPDATE "Ïðîåêò" set "ÄëÿÏîèñêà" = (
            		SELECT CASE WHEN "ÄîêóìåíòÐàñøèðåíèå"."Íàçâàíèå" IS NOT NULL AND "Ïðîåêò"."Îïèñàíèå" IS NOT NULL THEN "ÄîêóìåíòÐàñøèðåíèå"."Íàçâàíèå" || ' ' || "Ïðîåêò"."Îïèñàíèå"
            		            WHEN "ÄîêóìåíòÐàñøèðåíèå"."Íàçâàíèå" IS NOT NULL THEN "ÄîêóìåíòÐàñøèðåíèå"."Íàçâàíèå" 
            			        WHEN "Ïðîåêò"."Îïèñàíèå" IS NOT NULL THEN "Ïðîåêò"."Îïèñàíèå"
            			        ELSE NULL	
            		       END	    
            		FROM "ÄîêóìåíòÐàñøèðåíèå"
            		WHERE "ÄîêóìåíòÐàñøèðåíèå"."@Äîêóìåíò" = "Ïðîåêò"."@Äîêóìåíò"
    	             	) 
             WHERE "@Äîêóìåíò" IN (SELECT "@Äîêóìåíò" FROM "Äîêóìåíò" WHERE "ÒèïÄîêóìåíòà" = {})""".format(type_doc)
   SqlQuery(upd)</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="2" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Êàðà÷åâöåâ Þ.Þ." name="ÈñïðàâëåíèåÄóáëåéÎïèñàíèÿÇàäà÷Py_2" python_extension="1" responsible="Êàðà÷åâöåâ Þ.Þ.">
    <callback event="26">
      <body>sql = '''
update "ÄîêóìåíòÐàñøèðåíèå"
   set "Êîììåíòàðèé" = '',"Íàçâàíèå" = ''
   where "@Äîêóìåíò" in 
   (select dr."@Äîêóìåíò" from "ÄîêóìåíòÐàñøèðåíèå" dr
   LEFT JOIN "Ðàçëè÷íûåÄîêóìåíòû" rd ON dr."@Äîêóìåíò"=rd."@Äîêóìåíò"
   LEFT JOIN "Äîêóìåíò" d ON dr."@Äîêóìåíò"=d."@Äîêóìåíò"
   where 
   "ÒèïÄîêóìåíòà"=(select "@ÒèïÄîêóìåíòà" from "ÒèïÄîêóìåíòà" where "ÒèïÄîêóìåíòà"='ÑëóæÇàï' AND "ÏîäÒèïÄîêóìåíòà" is null order by "@ÒèïÄîêóìåíòà" LIMIT 1)
   AND rd."Èíôîðìàöèÿ" IS NOT NULL
   AND rd."Èíôîðìàöèÿ" &lt;&gt; ''
   AND (rd."Èíôîðìàöèÿ" = dr."Êîììåíòàðèé") OR (rd."Èíôîðìàöèÿ" = dr."Íàçâàíèå"));
'''
SqlQuery(sql)</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Êàðà÷åâöåâ Þ.Þ." name="ÈñïðàâëåíèåÑêîíâÇàäà÷" responsible="Ñàâèí Â.Â.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
BEGIN
   INSERT INTO "ËèöîÄîêóìåíòà"("Ëèöî", "Äîêóìåíò") select "Ñîòðóäíèê", "@Äîêóìåíò" from "Äîêóìåíò" d where 
   d."ÒèïÄîêóìåíòà"=(select "@ÒèïÄîêóìåíòà" from "ÒèïÄîêóìåíòà" where "ÒèïÄîêóìåíòà"='ÑëóæÇàï' AND "ÏîäÒèïÄîêóìåíòà" is NULL LIMIT 1)
   AND (select count(*) from "ËèöîÄîêóìåíòà" ld where ld."Äîêóìåíò"=d."@Äîêóìåíò")=0;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Ïàëî÷êèí Â.Â." name="ÍàçâàíèåÏàïîêÏëàíîâ" responsible="Ïàëî÷êèí Â.Â.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
   rec            record;
   pk             integer;
   face_name      text;
BEGIN
   -- îïðåäåë¤åì òèï äîêóìåíòà
   SELECT "@ÒèïÄîêóìåíòà" FROM "ÒèïÄîêóìåíòà" WHERE "ÒèïÄîêóìåíòà" = 'ÏëàíÐàáîò' INTO pk;
   IF pk IS NULL THEN
      RAISE NOTICE 'Íå íàøëè òèï äîêóìåíòà';
      RETURN;
   END IF;
   
   FOR rec  IN (
                  SELECT
                        "@Äîêóìåíò"    AS doc,
                        "Ñîòðóäíèê"    AS face
                  FROM "Äîêóìåíò"
                  WHERE "ÒèïÄîêóìåíòà" = pk
                        AND "$×åðíîâèê" IS NULL
                        AND "Óäàëåí" IS NOT TRUE
                        AND "Ðàçäåë@" IS TRUE

               )

      LOOP
			SELECT "Ôàìèëèÿ" || ' ' || "Èìÿ" || ' ' || "Îò÷åñòâî" FROM "×àñòíîåËèöî" WHERE "@Ëèöî" = rec.face LIMIT 1 INTO face_name;
			UPDATE "Ïðîåêò" SET "Îïèñàíèå" = face_name  WHERE "@Äîêóìåíò" = rec.doc;
      END LOOP;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="2" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Êàðà÷åâöåâ Þ.Þ." name="ÍàñòðîéêàÏðîåêòàÏîÐåãëàìåíòó_2" python_extension="1" responsible="Êàðà÷åâöåâ Þ.Þ.">
    <callback event="26">
      <body>SqlQuery('''
update "ÒèïÄîêóìåíòà" SET "ÍàñòðîéêàÊàðòî÷êèÄîêóìåíòà" = '[{"Presentation":"9785090d-86dd-4033-93f8-56eeabf42bb3","Config":{"Settings":[{"Type":"1","Name":"Çàêëàäêà Êîìàíäà","Values":[{"Value":"0","Title":"ïîêàçûâàòü"},{"Value":"1","Title":"íå ïîêàçûâàòü"}],"DefaultValue":"0","Controls":["ÇàêëàäêèÝòàïîâ"]},{"Type":"1","Name":"Çàêëàäêà Îïèñàíèå","Values":[{"Value":"0","Title":"ïîêàçûâàòü"},{"Value":"1","Title":"íå ïîêàçûâàòü"}],"DefaultValue":"0","Controls":["ÇàêëàäêèÝòàïîâ"]},{"Type":"1","Name":"Çàêëàäêà Çàòðàòû","Values":[{"Value":"0","Title":"ïîêàçûâàòü"},{"Value":"1","Title":"íå ïîêàçûâàòü"}],"DefaultValue":"0","Controls":["ÇàêëàäêèÝòàïîâ"]},{"Type":"1","Name":"Çàêëàäêà Õîä ïðîåêòà","Values":[{"Value":"0","Title":"ïîêàçûâàòü"},{"Value":"1","Title":"íå ïîêàçûâàòü"}],"DefaultValue":"0","Controls":["ÇàêëàäêèÝòàïîâ"]}]}}]'
where "ÒèïÄîêóìåíòà" = 'Ïðîåêò' ''')

SqlQuery('''
update "Ðåãëàìåíò" SET "ÂèçóàëüíîåÏðåäñòàâëåíèå" = '9785090d-86dd-4033-93f8-56eeabf42bb3',
"ÍàñòðîéêàÊàðòî÷êèÄîêóìåíòà" = ''
where "ÒèïÄîêóìåíòà" = (select "@ÒèïÄîêóìåíòà" from "ÒèïÄîêóìåíòà" where "ÒèïÄîêóìåíòà" = 'Ïðîåêò' LIMIT 1)
''')</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Èãíàòüåâ È.Â." name="ÎáíóëåíèåÄàòÓÏàïîêÏðîåêòîâ" responsible="Èãíàòüåâ È.Â.">
    <comment>Îáíóëåíèå ïîëåé ÏëàíÄàòàÍà÷ è ÏëàíÄàòàÊíö ó ïàïîê ïðîåêòîâ. Îíè äîëæíû áûòü ïóñòûìè.</comment>
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>BEGIN
   UPDATE "Ïðîåêò" proj
   SET "ÏëàíÄàòàÍà÷"=NULL, "ÏëàíÄàòàÊíö"=NULL
   WHERE proj."@Äîêóìåíò" IN (
      SELECT pr."@Äîêóìåíò" FROM "Ïðîåêò" pr
      LEFT JOIN "Äîêóìåíò" doc on doc."@Äîêóìåíò"=pr."@Äîêóìåíò"
      LEFT JOIN "ÒèïÄîêóìåíòà" dt on doc."ÒèïÄîêóìåíòà"=dt."@ÒèïÄîêóìåíòà"
      WHERE doc."Ðàçäåë@" = TRUE AND
            dt."ÒèïÄîêóìåíòà"='Ïðîåêò'
   );    
END;</body>
      <comment>Îáíóëåíèå ïîëåé ÏëàíÄàòàÍà÷ è ÏëàíÄàòàÊíö ó ïàïîê ïðîåêòîâ. Îíè äîëæíû áûòü ïóñòûìè.</comment>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Ïàëî÷êèí Â.Â." name="ÎáíóëåíèåÑ÷åò÷èêîâÓÏðîåêòîâ" responsible="Ïàëî÷êèí Â.Â.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>BEGIN
   UPDATE "Ïðîåêò" SET "ÄàòàÏîäñ÷åòà" = NULL;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="2" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Èãíàòüåâ È.Â." name="ÎêðóãÏëàíÂðåìåíèÏîÐàáîòàìÏëàíà" python_extension="1" responsible="Èãíàòüåâ È.Â.">
    <comment>Îêðóãëåíèå ïëàíîâîãî âðåìåíè ïî ðàáîòàì ïëàíà ðàáîò äëÿ êàæäîãî ñîòðóäíèêà. Âðåìÿ îò 0 äî 1 îòêðóãëÿåòñÿ äî 1, åñëè áîëüøå - îòðåçàåòñÿ íåöåëàÿ ÷àñòü.</comment>
    <callback event="26">
      <body>SqlQuery('''
   UPDATE "ËèöîÄîêóìåíòà" df SET "Âðåìÿ" = (SELECT trunc("Âðåìÿ"))
   WHERE "ÑâÿçüÄîêóìåíòîâ" IN (
           SELECT "@ÑâÿçüÄîêóìåíòîâ" FROM "ÑâÿçüÄîêóìåíòîâ" doc_link
           LEFT JOIN "Äîêóìåíò" doc ON doc."@Äîêóìåíò" = doc_link."ÄîêóìåíòÎñíîâàíèå"
           LEFT JOIN "ÒèïÄîêóìåíòà" dt ON dt."@ÒèïÄîêóìåíòà"=doc."ÒèïÄîêóìåíòà"
           WHERE dt."ÒèïÄîêóìåíòà" = 'ÏëàíÐàáîò'
   )
   AND "Âðåìÿ"&gt;1;
''')


SqlQuery('''
   UPDATE "ËèöîÄîêóìåíòà" df SET "Âðåìÿ" = 1
   WHERE "ÑâÿçüÄîêóìåíòîâ" IN (
           SELECT "@ÑâÿçüÄîêóìåíòîâ" FROM "ÑâÿçüÄîêóìåíòîâ" doc_link
           LEFT JOIN "Äîêóìåíò" doc ON doc."@Äîêóìåíò" = doc_link."ÄîêóìåíòÎñíîâàíèå"
           LEFT JOIN "ÒèïÄîêóìåíòà" dt ON dt."@ÒèïÄîêóìåíòà"=doc."ÒèïÄîêóìåíòà"
           WHERE dt."ÒèïÄîêóìåíòà" = 'ÏëàíÐàáîò'
   )
   AND "Âðåìÿ"&gt;0 AND "Âðåìÿ"&lt;1;
END;
''')</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Çèìèí Â.À." name="Î÷èñòêàÈñòîðèèÔèëüòðÍàÄèàëÂåõè" responsible="Çèìèí Â.À.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>BEGIN
   UPDATE "Ïàðàìåòð"
   SET "Çíà÷åíèå" = NULL
   WHERE 
      "Ïàðàìåòð"."Íàçâàíèå" = 'ÔèëüòðÒàáëèöûÑâÿçåéÑÂåõîéÇÈ-ÑîñòîÿíèåÂåõ-historyFilters' OR
      "Ïàðàìåòð"."Íàçâàíèå" = 'ÔèëüòðÒàáëèöûÑâÿçåéÑÂåõîéÇÈ-ÑîñòîÿíèåÂåõ-historyData' OR
      "Ïàðàìåòð"."Íàçâàíèå" = 'ÔèëüòðÒàáëèöûÑâÿçåéÑÂåõîéÇÈ-ÑîñòîÿíèåÂåõ-rememberData' OR
      "Ïàðàìåòð"."Íàçâàíèå" = 'ÔèëüòðÒàáëèöûÑâÿçåéÑÂåõîéÇÈ-ÑîñòîÿíèåÂåõ-filterViewData';
END;</body>
      <comment>Êîíâåðòåð íóæíî âûïîëíèòü îäèí ðàç, ÷òîáû óäàëèòü äóáëè â ñëîæíîì ôèëüòðå íà äèàëîãå âåõè.</comment>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Ïàëî÷êèí Â.Â." name="Î÷èñòêàËèöàÓÇîí" responsible="Ïàëî÷êèí Â.Â.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
BEGIN
UPDATE "Ëèöî" SET "Íàçâàíèå" = NULL WHERE "@Ëèöî" IN (
   SELECT "@Ëèöî" FROM "ÔóíêöèîíàëüíàÿÎáëàñòü"
);
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Øàðàøîâ Ì.À." name="ÏåðåíîñÈçìåíåíèÿÑðîêà" responsible="Øàðàøîâ Ì.À.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
BEGIN
UPDATE "Ïðîåêò" SET "ÈçìåíåíèåÑðîêà" = TRUE WHERE "@Äîêóìåíò" IN (  SELECT DISTINCT doc."@Äîêóìåíò"  
    FROM "Äîêóìåíò" doc
    LEFT JOIN "ÏðîåêòÑîáûòèå" event
         ON doc."@Äîêóìåíò" = COALESCE(event."ÄîêóìåíòÑëåäñòâèå", event."Äîêóìåíò")
    WHERE event."Òèï" = 7
          AND (event."ÄîêóìåíòÑëåäñòâèå" = doc."@Äîêóìåíò"
             OR (event."Äîêóìåíò" =  doc."@Äîêóìåíò" AND event."ÄîêóìåíòÑëåäñòâèå" IS NULL))
    );
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Ñàâèí Â.Â." name="ÏðîñòàâëåíèåÏîðÍîìåðÏðîåêòàì" responsible="Ñàâèí Â.Â.">
    <comment>Çàïîëíÿåì êîëîíêó ÏîðÍîìåð äëÿ óæå ñîçäàííûõ Ïðîåêòîâ, Ýòàïîâ, ó êîòîðûõ ýòîò ïàðìåòð íåçàäàí.</comment>
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="1">
      <body>DECLARE
BEGIN
   UPDATE "Ïðîåêò" SET "ÏîðÍîìåð"="@Äîêóìåíò" WHERE "ÏîðÍîìåð" IS NULL;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="1" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Ïàëî÷êèí Â.Â." name="ÑáðîñÄàòûÂåõè" python_extension="1" responsible="Ïàëî÷êèí Â.Â.">
    <callback event="1">
      <body>SqlQuery("""
UPDATE "Âåõà"
SET "Äàòà" = NULL
""")</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Íèêèòèí Å.Ñ." name="ÑáðîñÑîñòîÿíèÿÂåõè" responsible="Íèêèòèí Å.Ñ.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="1">
      <body>DECLARE
BEGIN
   UPDATE "Âåõà"
   SET "Ñîñòîÿíèå" = 0
   WHERE "Ñîñòîÿíèå" = 6;
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="1" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Ïàëî÷êèí Â.Â." name="ÑáðîñèòüÂðåìÿÏåðåñ÷åòàÏðîâåðîê" python_extension="1" responsible="Ïàëî÷êèí Â.Â.">
    <callback event="26">
      <body>SqlQuery("""
UPDATE "×åêëèñòÑòðóêòóðà"
SET "ÄàòàÂðåìÿÏåðåñ÷åòà" = NULL
""")</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Çèìèí Â.À." name="ÓäàëÌóñîðàÑâÿçüÄîêóìåíòîâÏëàí" responsible="Çèìèí Â.À.">
    <comment>Èç-çà íåïðàâèëüíîãî ôîðìàòà îáúåêòà ÑâÿçüÄîêóìåíòîâ â òàáëèöå ÑâÿçüÄîêóìåíòîâÏëàí ñêîïèëîñü ìíîæåñòâî ëèøíèõ çàïèñåé. Îáúåêò ïîïðàâèëè, çàïèñè óäàëÿåì.</comment>
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>BEGIN
   DELETE FROM "ÑâÿçüÄîêóìåíòîâÏëàí"
   WHERE "@ÑâÿçüÄîêóìåíòîâ" in (
      SELECT   
        "ÑâÿçüÄîêóìåíòîâ"."@ÑâÿçüÄîêóìåíòîâ"  
      FROM 
        "ÑâÿçüÄîêóìåíòîâ", 
        "ÑâÿçüÄîêóìåíòîâÏëàí", 
        "Äîêóìåíò", 
        "ÒèïÄîêóìåíòà"
      WHERE 
        "ÑâÿçüÄîêóìåíòîâ"."@ÑâÿçüÄîêóìåíòîâ" = "ÑâÿçüÄîêóìåíòîâÏëàí"."@ÑâÿçüÄîêóìåíòîâ" AND
        "ÑâÿçüÄîêóìåíòîâ"."ÄîêóìåíòÎñíîâàíèå" = "Äîêóìåíò"."@Äîêóìåíò" AND
        "Äîêóìåíò"."ÒèïÄîêóìåíòà" = "ÒèïÄîêóìåíòà"."@ÒèïÄîêóìåíòà" AND
        "ÒèïÄîêóìåíòà"."Íàçâàíèå" != 'Ïëàíû ðàáîò' AND
        coalesce("ÑâÿçüÄîêóìåíòîâ"."ÂèäÑâÿçè", 0) NOT IN (14, 15)
   );
END;</body>
      <comment>Êîíâåðòåð íóæíî âûïîëíèòü îäèí ðàç, ÷òîáû óäàëèòü äóáëè â ñëîæíîì ôèëüòðå íà äèàëîãå âåõè.</comment>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" for_new_db="0" last_changed="Ïàëî÷êèí Â.Â." name="ÓäàëåíèåÏðîåêòîâÓäàëåííîéÏàïêè" responsible="Ïàëî÷êèí Â.Â.">
    <rule name=".*" schema=".*" stage="1" type="0"/>
    <callback event="26">
      <body>DECLARE
BEGIN
   UPDATE "Äîêóìåíò" SET "Óäàëåí" = TRUE 
   WHERE "@Äîêóìåíò" IN (
      WITH RECURSIVE tmp AS (
         select 
            proj."@Äîêóìåíò" 
         from "Ïðîåêò" proj
         INNER JOIN "Äîêóìåíò" doc
            ON doc."@Äîêóìåíò" = proj."@Äîêóìåíò"
         INNER JOIN "ÒèïÄîêóìåíòà" t_d
            ON t_d."@ÒèïÄîêóìåíòà" = doc."ÒèïÄîêóìåíòà"
         WHERE doc."Ðàçäåë@" IS TRUE 
               AND t_d."ÒèïÄîêóìåíòà" = 'Ïðîåêò' 
               AND doc."Óäàëåí" IS TRUE
      ),
      aaa AS (
         select 
            proj."@Äîêóìåíò", 
            1 AS "Óðîâåíü" , 
            proj."ÑîñòîÿíèåÏðîåêòà", 
            doc."Óäàëåí"
         from "Ïðîåêò" proj
         INNER JOIN "Äîêóìåíò" doc
            ON doc."@Äîêóìåíò" = proj."@Äîêóìåíò"
         INNER JOIN tmp
            ON tmp."@Äîêóìåíò" = doc."Ðàçäåë"
         INNER JOIN "ÒèïÄîêóìåíòà" t_d
            ON t_d."@ÒèïÄîêóìåíòà" = doc."ÒèïÄîêóìåíòà"
         WHERE t_d."ÒèïÄîêóìåíòà" = 'Ïðîåêò' 
               AND doc."Óäàëåí" IS NOT TRUE

         UNION ALL
         
         select 
            proj."@Äîêóìåíò", 
            aaa."Óðîâåíü" + 1  AS "Óðîâåíü", 
            proj."ÑîñòîÿíèåÏðîåêòà", 
            doc."Óäàëåí"
         from "Ïðîåêò" proj
         INNER JOIN "Äîêóìåíò" doc
            ON doc."@Äîêóìåíò" = proj."@Äîêóìåíò"
         INNER JOIN aaa
            ON aaa."@Äîêóìåíò" = doc."Ðàçäåë"
         INNER JOIN "ÒèïÄîêóìåíòà" t_d
            ON t_d."@ÒèïÄîêóìåíòà" = doc."ÒèïÄîêóìåíòà"
         WHERE t_d."ÒèïÄîêóìåíòà" = 'Ïðîåêò' 
               AND doc."Óäàëåí" IS NOT TRUE
               AND "Óðîâåíü" &lt; 20
      )
      select aaa."@Äîêóìåíò" from aaa
   );
END;</body>
    </callback>
  </converter>

  <converter abstract="0" call_once="1" deployment_stage="1" for_new_db="0" for_personal_schemas="1" for_public_schema="0" last_changed="Ïàëî÷êèí Â.Â." name="ÓñòàíîâêàÄàòûÂåõè" python_extension="1" responsible="Ïàëî÷êèí Â.Â.">
    <callback event="26">
      <body>SqlQuery("""
WITH T AS (
    SELECT veha."@Äîêóìåíò" AS "Äîêóìåíò",
        doc."Äàòà"
    FROM "Âåõà" veha
    LEFT JOIN "Äîêóìåíò" doc
        ON doc."@Äîêóìåíò" = veha."@Äîêóìåíò"
)
UPDATE "Âåõà" SET "Äàòà" = T."Äàòà" FROM T WHERE "@Äîêóìåíò" = T."Äîêóìåíò"
""")</body>
    </callback>
  </converter>

</converter_library>
